---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import '../../styles/global.css';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get all categories
const categories = [...new Set(allPosts.map(post => post.data.category))];

// Get all tags
const allTags = allPosts.flatMap(post => post.data.tags);
const tagCounts = allTags.reduce((acc, tag) => {
  acc[tag] = (acc[tag] || 0) + 1;
  return acc;
}, {} as Record<string, number>);
const popularTags = Object.entries(tagCounts)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)
  .map(([tag]) => tag);
---

<BaseLayout title="Bài viết | AI Blog" description="Danh sách tất cả bài viết về AI, Machine Learning và công nghệ">
  <Header />
  
  <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Page Header -->
      <div class="mb-12">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
          Tất cả bài viết
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-400">
          Khám phá {sortedPosts.length} bài viết về AI và công nghệ
        </p>
      </div>
      
      <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-12">
        <!-- Posts Grid -->
        <div>
          {sortedPosts.length > 0 ? (
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              {sortedPosts.map((post) => (
                <BlogCard post={post} />
              ))}
            </div>
          ) : (
            <div class="text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-xl">
              <p class="text-gray-600 dark:text-gray-400">
                Chưa có bài viết nào.
              </p>
            </div>
          )}
        </div>
        
        <!-- Sidebar -->
        <aside class="hidden lg:block space-y-8">
          <!-- Categories -->
          <div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-xl">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
              Danh mục
            </h2>
            <ul class="space-y-2">
              {categories.map((category) => (
                <li>
                  <a 
                    href={`/blog/categories/${category.toLowerCase().replace(' ', '-')}/`}
                    class="flex items-center justify-between text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
                  >
                    <span>{category}</span>
                    <span class="text-sm bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">
                      {allPosts.filter(p => p.data.category === category).length}
                    </span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
          
          <!-- Popular Tags -->
          <div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-xl">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
              Tags phổ biến
            </h2>
            <div class="flex flex-wrap gap-2">
              {popularTags.map((tag) => (
                <a 
                  href={`/blog/tags/${tag.toLowerCase()}/`}
                  class="tag"
                >
                  #{tag}
                </a>
              ))}
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>
